# Chrome Extension Development Prompt

## Basic Policy
Follow these guidelines to develop a maintainable Chrome extension using webextension-toolbox/generator-web-extension.

When generating code based on the following guidelines, all code comments and function descriptions (e.g., JSDoc) must be written in Japanese. The code itself (variable names, function names, etc.) must be in English.

## Generator-web-extension Prerequisite
This prompt assumes the use of an Advanced WebExtension generator that creates everything you need to get started with cross-browser extension/addon development.

**Setup Steps:**
```shell script
# Install the generator
npm install -D @webextension-toolbox/webextension-toolbox

# Create project directory
mkdir my-web-extension && cd my-web-extension

```


**webextension-toolbox Features:**
- Automatically adds necessary polyfills for cross-browser support (Chrome, Firefox, Edge, Opera, Safari)
- webpack-based build system
- Hot reload for development
- Production build optimization
- Cross-browser extension development with unified API
- Automatic manifest.json generation for different browsers
- Built-in TypeScript support when configured

**Important: Browser Target Specification Required**
webextension-toolbox requires explicit browser target specification to avoid build errors. Always specify the target browser when running development or build commands. Failing to specify a browser target will result in build failures.

## Naming Conventions and Code Quality

### Naming Practices
- Use specific variable names that clearly indicate type and purpose (e.g., `userData` → `currentUserProfile`)
- Start function names with verbs that describe the action and return value (e.g., `fetchUserSettings`, `validateFormData`)
- Use affirmative interrogatives for boolean values (`isValid`, `hasPermission`, `canExecute`)
- Express constants in uppercase snake case with meaningful names (`API_ENDPOINT_URL`, `MAX_RETRY_COUNT`)

### Function Design
- Each function should have a single responsibility and be 20-30 lines or less
- Use early return patterns to keep nesting within 2 levels
- Decompose complex conditions into explanatory variables to improve readability

### Comment Strategy
- Document business requirements and constraints from a "why" perspective
- Include overviews and rationale for complex algorithms
- Clearly document Chrome extension-specific constraints and permission requirements

## File Structure

### Directory Structure Conforming to generator-web-extension
Adopt the following extended directory structure based on the basic structure generated by webextension-toolbox:

```
my-web-extension/
├── package.json                # Dependencies and script definitions
├── webpack.config.js           # webpack configuration (for customization)
├── .webextensiontoolboxrc      # toolbox configuration file
├── README.md                   # Project overview and setup instructions
├── DEVELOPMENT.md              # Development guide and build procedures
├── ARCHITECTURE.md             # System design and component relationships
├── SECURITY.md                 # Security considerations and permission explanations
├── app/                        # Source code (generated by generator)
│   ├── manifest.json           # Extension manifest
│   ├── _locales/              # Internationalization
│   │   ├── README.md          # Multilingual support and translation management
│   │   ├── en/
│   │   │   └── messages.json
│   │   └── ja/
│   │       └── messages.json
│   ├── images/                # Icons and image resources
│   │   ├── README.md          # Image optimization, licensing, and icon standards
│   │   ├── icon-16.png
│   │   ├── icon-48.png
│   │   └── icon-128.png
│   ├── pages/                 # HTML pages
│   │   ├── README.md          # Page specifications and navigation
│   │   ├── popup.html         # Popup UI
│   │   └── options.html       # Settings page
│   ├── scripts/               # TypeScript scripts
│   │   ├── README.md          # Script overview and dependencies
│   │   ├── background.ts      # Background script
│   │   ├── contentscript.ts   # Content script
│   │   ├── popup.ts           # Popup control
│   │   ├── options.ts         # Settings page control
│   │   ├── lib/               # Common libraries and utilities
│   │   │   ├── README.md      # Library specifications, API, and usage examples
│   │   │   ├── utils.ts       # General functions
│   │   │   ├── constants.ts   # Constant definitions
│   │   │   ├── api.ts         # Chrome API wrapper
│   │   │   └── storage.ts     # Storage management
│   │   ├── modules/           # Feature modules
│   │   │   ├── README.md      # Module design and interdependencies
│   │   │   ├── auth/          # Authentication
│   │   │   │   ├── README.md  # Authentication specifications and security considerations
│   │   │   │   ├── auth.ts
│   │   │   │   └── token.ts
│   │   │   ├── ui/            # UI operations and DOM control
│   │   │   │   ├── README.md  # UI specifications and event handling
│   │   │   │   ├── popup-ui.ts
│   │   │   │   └── content-ui.ts
│   │   │   └── data/          # Data processing and API communication
│   │   │       ├── README.md  # Data flow and API specifications
│   │   │       ├── fetch.ts
│   │   │       └── parser.ts
│   │   └── vendor/            # External libraries (if needed)
│   │       └── README.md      # External dependencies, licensing, and update policies
│   ├── styles/                # CSS stylesheets
│   │   ├── README.md          # Style guidelines, design policies, and theme management
│   │   ├── popup.css
│   │   ├── options.css
│   │   ├── content.css        # For content scripts
│   │   └── common.css         # Common styles
│   └── tests/                 # Test files (recommended addition)
│       ├── README.md          # Test execution methods and coverage requirements
│       ├── unit/
│       │   ├── README.md      # Unit test specifications and mock usage
│       │   ├── utils.test.ts
│       │   └── api.test.ts
│       ├── integration/
│       │   ├── README.md      # Integration and Chrome API testing
│       │   └── extension.test.ts
│       └── e2e/
│           ├── README.md      # E2E tests, automation, and browser settings
│           └── popup.test.ts
└── dist/                      # Build output (git ignore)
    ├── chrome/
    ├── firefox/
    ├── opera/
    └── edge/
```


### Integration Points with generator-web-extension
- **Utilize the basic structure generated by `yo web-extension`**
- **`webpack.config.js` can be customized to configure additional loaders and plugins**
- **Use `.webextensiontoolboxrc` to manage toolbox-specific settings**
- **Extend and organize the structure within the `app/` directory as shown above**

## webextension-toolbox Development Workflow

### Development Commands
**Critical: Always specify browser target to avoid build errors**

```shell script
# Get help for webextension-toolbox commands
$ webextension-toolbox dev --help

# Development build with hot reload (REQUIRED: specify browser target)
$ webextension-toolbox dev chrome    # Chrome development build
$ webextension-toolbox dev firefox   # Firefox development build
$ webextension-toolbox dev edge      # Edge development build
$ webextension-toolbox dev safari    # Safari development build

# Alternative npm script commands (if configured in package.json)
npm run dev chrome    # Chrome development build
npm run dev firefox   # Firefox development build
npm run dev edge      # Edge development build
npm run dev safari    # Safari development build

# Production build (REQUIRED: specify browser target)
$ webextension-toolbox build chrome  # Optimized Chrome build
$ webextension-toolbox build firefox # Optimized Firefox build
$ webextension-toolbox build edge    # Optimized Edge build
$ webextension-toolbox build safari  # Optimized Safari build

# Alternative npm script commands for production
npm run build chrome  # Optimized Chrome build
npm run build firefox # Optimized Firefox build
npm run build edge    # Optimized Edge build
npm run build safari  # Optimized Safari build

# Build for all browsers (if configured)
npm run build

# Run tests
npm test              # Unit tests
npm run test:e2e      # E2E tests
```

**Note:** Omitting the browser target (chrome, firefox, edge, safari) will result in build errors. Always specify which browser you're targeting to ensure proper polyfills and manifest generation.


### Customizing webpack Configuration
Extend the `webpack.config.js` generated by generator-web-extension to implement additional features:

```typescript
// webpack.config.js extension example
import * as webextensionToolbox from 'webextension-toolbox/dist/webpack.config.js';
import { Configuration } from 'webpack';

interface WebpackEnv {
  [key: string]: any;
}

interface WebpackArgv {
  mode?: 'development' | 'production';
  [key: string]: any;
}

module.exports = (env: WebpackEnv, argv: WebpackArgv): Configuration => {
  const config = webextensionToolbox(env, argv);

  // TypeScriptサポートを追加
  config.module!.rules!.push({
    test: /\.tsx?$/,
    use: 'ts-loader',
    exclude: /node_modules/,
  });

  // Vue.jsサポートを追加
  config.module!.rules!.push({
    test: /\.vue$/,
    loader: 'vue-loader'
  });

  return config;
};
```


## Chrome Extension-Specific Implementation

### Manifest Design
- Request only the minimum necessary permissions
- Document permission reasons with comments
- Consider version management and update strategies

### Messaging
- Define type-safe message schemas for background-content communication
- Implement robust communication patterns with error handling
- Standardize asynchronous processing with Promise-based approaches

### Storage Management
- Persistent configuration data using `chrome.storage`
- Appropriate use of sync and local storage
- Clearly define data formats and version management

## Security Measures

### Content Security Policy
- Defend against XSS attacks with appropriate CSP settings
- Avoid inline scripts and separate into external files
- Allow only trusted resources

### Permission Management
- Follow the principle of least privilege, requesting only necessary permissions
- Clearly document permission usage in comments
- Properly encrypt and protect user data

### Input Validation
- Always validate user input and data from web pages
- Execute appropriate escaping during DOM operations to prevent XSS
- Strictly validate data from untrusted sources

## Performance Optimization

### Resource Management
- Design to minimize memory usage
- Properly clean up unused event listeners
- Execute large DOM operations in optimized batches

### Asynchronous Processing
- Use Web Workers for heavy processing to prevent UI blocking
- Implement appropriate caching strategies for API calls
- Use efficient mechanisms for state synchronization between tabs

## Testing Strategy

### Unit Testing
- Maintain test coverage of business logic at 80% or higher
- Use Chrome API mocks to set up test environments
- Verify asynchronous processing with appropriate assertions

### Integration Testing
- Automate verification of actual Chrome operation
- Test operation across multiple tabs and windows
- Test compatibility across different websites

## Error Handling

### Comprehensive Exception Handling
```typescript
// エラーハンドリング用の型定義
interface OperationResult<T> {
  success: boolean;
  data?: T;
  error?: string;
  context?: string;
}

interface ErrorInfo {
  message: string;
  stack?: string;
  timestamp: string;
}

// 汎用的なエラーハンドリング関数
async function executeWithErrorHandling<T>(
  operation: () => Promise<T>,
  context: string
): Promise<OperationResult<T>> {
  try {
    const result = await operation();
    return { success: true, data: result };
  } catch (error) {
    const errorInfo: ErrorInfo = {
      message: error instanceof Error ? error.message : String(error),
      stack: error instanceof Error ? error.stack : undefined,
      timestamp: new Date().toISOString()
    };

    console.error(`Operation failed in ${context}:`, errorInfo);

    return {
      success: false,
      error: getUserFriendlyMessage(error),
      context: context
    };
  }
}

// ユーザーフレンドリーなエラーメッセージを生成する関数
function getUserFriendlyMessage(error: unknown): string {
  if (error instanceof Error) {
    return error.message;
  }
  return 'An unexpected error occurred';
}
```


### Chrome API Error Handling
- Always check for `chrome.runtime.lastError`
- Prepare appropriate responses for permission errors and API limitation errors
- Provide user-friendly error messages

## Documentation Requirements

### Required Documents at Project Root
- **README.md**: Extension overview, installation method, usage instructions
- **DEVELOPMENT.md**: Development environment setup, build procedures
- **ARCHITECTURE.md**: System design, component relationships
- **SECURITY.md**: Security considerations, permission explanations

### Directory-Specific README.md Requirements

| Directory | Required Content | Update Timing |
|-------------|-------------|---------------|
| `background/README.md` | Background process overview, permission justification, main APIs | When background processing changes |
| `content/README.md` | Target sites, DOM operation specifications, security considerations | When content processing changes |
| `popup/README.md` | UI specifications, operation flow, state management method | When UI changes |
| `options/README.md` | Setting item explanations, validation specifications, default values | When settings change |
| `shared/README.md` | Common functionality overview, dependencies, usage guidelines | When common functionality is added |
| `shared/utils/README.md` | Specifications for all functions, arguments, return values, usage examples, test cases | When functions are added/modified |
| `shared/constants/README.md` | Constant classification, usage explanation, impact scope of changes | When constants are added/modified |
| `shared/types/README.md` | Type definition list, usage locations, extension methods | When type definitions change |
| `shared/api/README.md` | Chrome API wrapper specifications, error handling | When API changes |
| `assets/README.md` | Resource management conventions, optimization methods, license information | When assets are added |

### README.md Quality Standards
- [ ] New developers can understand the function within 30 minutes
- [ ] Specific code examples and usage methods are included
- [ ] Error patterns and troubleshooting are documented
- [ ] Dependencies on other modules are clearly stated
- [ ] Future expansion plans and limitations are described

### In-Code Documentation
- Detailed explanations of Chrome API usage
- Background and constraints of complex business logic
- Security considerations and reasons for permission requests

## Quality Assurance

### Recommended Patterns
- Manage configurable constants in dedicated files
- Create reusable utility functions
- Maintain API consistency with type definitions (when using TypeScript)
- Adopt consistent error handling patterns

### Patterns to Avoid
- Use named constants instead of magic numbers
- Execute appropriate function splitting instead of huge functions
- Adopt appropriate scope design instead of global variables
- Utilize asynchronous patterns instead of synchronous processing

## Continuous Improvement

### Quality Metrics
- Monitor bundle size and memory usage
- Measure extension startup time and response time
- Track error occurrence rate and user reports
- Regularly check security scan results

### Update Strategy
- Develop a phased rollout plan
- Implement migration strategies that maintain backward compatibility
- Build mechanisms to collect user feedback

---

**Implementation Notes:**
1. **Utilize the project structure generated by generator-web-extension as a foundation**
2. **Maximize the cross-browser compatibility features of webextension-toolbox**
3. **Always place README.md in each directory, documenting function overview and usage**
4. **Consolidate common functionality under `app/scripts/lib/` to enhance reusability**
5. **Appropriately integrate additional functionality (TypeScript, Vue.js, etc.) by customizing webpack.config.js**
6. **Manage project-specific settings in `.webextensiontoolboxrc`**
7. **Implement multilingual support using `_locales/`**
8. **Balance security and performance**
9. **Create comprehensive tests and documentation**
10. **Strive for continuous quality improvement**
11. **Update documentation simultaneously with code changes**

## webextension-toolbox Optimization

### Build Optimization
- **Development**: Utilize hot reload with `webextension-toolbox dev [browser]`
- **Production**: Generate optimized bundles with `webextension-toolbox build [browser]`
- **Multi-browser Support**: Streamline CI pipelines with simultaneous builds

### Performance Considerations
- Utilize webpack bundle size optimization features of webextension-toolbox
- Configure removal of unnecessary polyfills
- Enable tree-shaking to eliminate unused code

### Debugging & Testing Strategy
- Integration with Chrome Developer Tools
- Automate verification across browsers
- Utilize webextension-toolbox's hot reload feature

## README.md Template Example

### Directory-Specific Template Usage
When creating README.md for each directory, refer to the following section structure:

```markdown
# [ディレクトリ名] - [機能概要]

## 概要
この機能の役割と責任について説明

## 主要ファイル
- `file1.ts`: 機能説明
- `file2.ts`: 機能説明

## 使用方法
具体的なコード例とAPI使用法

## 依存関係
- 内部依存: 他のモジュールとの関係
- 外部依存: Chrome API、ライブラリ
- webextension-toolbox: ビルド・変換依存

## 設定・権限
必要な権限と設定項目

## クロスブラウザ対応
各ブラウザでの動作差異と対応方法

## エラーハンドリング
想定されるエラーと対処法

## テスト
テスト方法とカバレッジ要件

## 拡張・カスタマイズ
将来的な機能拡張の指針

## 注意事項
制限事項やセキュリティ考慮事項
```

